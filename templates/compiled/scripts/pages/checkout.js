define("modules/models-checkout",["modules/jquery-mozu","underscore","hyprlive","modules/backbone-mozu","modules/api","modules/models-customer","modules/models-address","modules/models-paymentmethods","hyprlivecontext"],function(e,t,i,n,a,r,o,s,d){var l=n.MozuModel.extend({helpers:["stepStatus","requiresFulfillmentInfo","requiresDigitalFulfillmentContact"],initStep:function(){var e=this;this.next=function(i){return t.debounce(function(){e.isLoading()||i.call(e)},750,!0)}(this.next);var i=e.getOrder();e.calculateStepStatus(),e.listenTo(i,"error",function(){e.isLoading()&&e.isLoading(!1)}),e.set("orderId",i.id),e.apiModel&&e.apiModel.on("action",function(t,n){n?n.orderId=i.id:e.apiModel.prop("orderId",i.id)})},calculateStepStatus:function(){var e=this.isValid(!this.stepStatus())?"complete":"invalid";return this.stepStatus(e)},getOrder:function(){return this.parent},stepStatus:function(e){return arguments.length>0&&(this._stepStatus=e,this.trigger("stepstatuschange",e)),this._stepStatus},requiresFulfillmentInfo:function(){return this.getOrder().get("requiresFulfillmentInfo")},requiresDigitalFulfillmentContact:function(){return this.getOrder().get("requiresDigitalFulfillmentContact")},edit:function(){this.stepStatus("incomplete")},next:function(){this.submit()&&this.isLoading(!0)}}),c=l.extend({relations:r.Contact.prototype.relations,validation:r.Contact.prototype.validation,digitalOnlyValidation:{email:{pattern:"email",msg:i.getLabel("emailMissing")}},dataTypes:{contactId:function(e){return"new"===e?e:n.MozuModel.DataTypes.Int(e)}},helpers:["contacts"],contacts:function(){var e=this.getOrder().get("customer").get("contacts").toJSON();return e&&e.length>0&&e},initialize:function(){this.on("change:contactId",function(e,t){t&&"new"!==t?e.set(e.getOrder().get("customer").get("contacts").get(t).toJSON(),{silent:!0}):(e.get("address").clear(),e.get("phoneNumbers").clear(),e.unset("id"),e.unset("firstName"),e.unset("lastNameOrSurname"))})},calculateStepStatus:function(){return!this.requiresFulfillmentInfo()&&this.requiresDigitalFulfillmentContact()&&(this.validation=this.digitalOnlyValidation),this.requiresFulfillmentInfo()||this.requiresDigitalFulfillmentContact()?l.prototype.calculateStepStatus.apply(this):this.stepStatus("complete")},getOrder:function(){return this.parent.parent},choose:function(t){var i=parseInt(e(t.currentTarget).val(),10);if(-1!==i){var n=this.get("address"),a=n.get("candidateValidatedAddresses")[i];for(var r in a)n.set(r,a[r])}},toJSON:function(){return this.requiresFulfillmentInfo()||this.requiresDigitalFulfillmentContact()?l.prototype.toJSON.apply(this,arguments):void 0},isDigitalValid:function(){var e=this.get("email");return e?!0:!1},nextDigitalOnly:function(){var e=this.getOrder(),t=this;return this.validate()?!1:(this.getOrder().apiModel.update({fulfillmentInfo:t.toJSON()}).ensure(function(){return t.provisional=!1,t.isLoading(!1),e.messages.reset(),e.syncApiModel(),t.calculateStepStatus(),e.get("billingInfo").calculateStepStatus()}),void 0)},next:function(){if(!this.requiresFulfillmentInfo()&&this.requiresDigitalFulfillmentContact())return this.nextDigitalOnly();if(this.validate())return!1;var e=this.parent,n=this.getOrder(),a=this,r=d.locals.siteContext.generalSettings.isAddressValidationEnabled,o=d.locals.siteContext.generalSettings.allowInvalidAddresses;this.isLoading(!0);var s=this.get("address"),l=function(){n.messages.reset(),n.syncApiModel(),a.isLoading(!0),n.apiModel.getShippingMethodsFromContact().then(function(t){return e.refreshShippingMethods(t)}).ensure(function(){s.set("candidateValidatedAddresses",null),a.isLoading(!1),e.isLoading(!1),a.calculateStepStatus(),e.calculateStepStatus()})},c=function(){n.syncApiModel(),a.isLoading(!1),e.isLoading(!1),a.stepStatus("invalid")};if(r)if(s.get("candidateValidatedAddresses"))l();else{var u=o?"validateAddressLenient":"validateAddress";s.apiModel[u]().then(function(e){if(e.data&&e.data.addressCandidates&&e.data.addressCandidates.length){if(t.find(e.data.addressCandidates,s.is,s))return s.set("isValidated",!0),l(),void 0;s.set("candidateValidatedAddresses",e.data.addressCandidates),c()}else l()},function(){o?(n.messages.reset(),l()):n.messages.reset({message:i.getLabel("addressValidationError")})})}else l()}}),u=l.extend({initialize:function(){this.updateShippingMethod(this.get("shippingMethodCode")),this.on("change:availableShippingMethods",function(e){e.updateShippingMethod(e.get("shippingMethodCode"))})},relations:{fulfillmentContact:c},validation:{shippingMethodCode:{required:!0,msg:i.getLabel("chooseShippingMethod")}},refreshShippingMethods:function(e){this.set({availableShippingMethods:e}),t.each(["shippingMethodCode","shippingMethodName"],this.unset,this)},calculateStepStatus:function(){var e;return this.requiresFulfillmentInfo()?this.provisional?this.stepStatus("incomplete"):"complete"!==this.get("fulfillmentContact").stepStatus()?this.stepStatus("new"):(e=this.get("availableShippingMethods"),e&&e.length&&t.findWhere(e,{shippingMethodCode:this.get("shippingMethodCode")})?this.stepStatus("complete"):this.stepStatus("incomplete")):this.stepStatus("complete")},updateShippingMethod:function(e){var i=this.get("availableShippingMethods"),n=t.findWhere(i,{shippingMethodCode:e});!n&&i&&i[0]&&(n=i[0],this.provisional=!0),n&&this.set(n)},next:function(){if(this.validate())return!1;var e=this;this.isLoading(!0),this.getOrder().apiModel.update({fulfillmentInfo:e.toJSON()}).ensure(function(){e.provisional=!1,e.isLoading(!1),e.calculateStepStatus(),e.parent.get("billingInfo").calculateStepStatus()})}}),p=l.extend({mozuType:"payment",validation:{paymentType:{required:!0,msg:i.getLabel("paymentTypeMissing")},"billingContact.email":{pattern:"email",msg:i.getLabel("emailMissing")}},dataTypes:{isSameBillingShippingAddress:n.MozuModel.DataTypes.Boolean,creditAmountToApply:n.MozuModel.DataTypes.Float},relations:{billingContact:r.Contact,card:s.CreditCard,check:s.Check},helpers:["acceptsMarketing","savedPaymentMethods","availableStoreCredits","applyingCredit","maxCreditAmountToApply","activeStoreCredits","nonStoreCreditTotal","activePayments","availableDigitalCredits","digitalCreditPaymentTotal","isAnonymousShopper"],acceptsMarketing:function(){return this.getOrder().get("acceptsMarketing")},activePayments:function(){return this.getOrder().apiModel.getActivePayments()},nonStoreCreditTotal:function(){var e,i=this,n=this.getOrder(),a=n.get("total"),r=this.activeStoreCredits();return r?(e=a-t.reduce(r,function(e,t){return e+t.amountRequested},0),i.roundToPlaces(e,2)):a},savedPaymentMethods:function(){var e=this.getOrder().get("customer").get("cards").toJSON();return e&&e.length>0&&e},activeStoreCredits:function(){var e=this.getOrder().apiModel.getActiveStoreCredits();return e&&e.length>0&&e},availableStoreCredits:function(){var e=this.getOrder(),i=e.get("customer"),n=i&&i.get("credits"),a=this.activeStoreCredits(),r=n&&t.compact(t.map(n.models,function(e){return"StoreCredit"!==e.creditType&&"GiftCard"!==e.creditType?!1:(e=t.clone(e),a&&t.each(a,function(t){t.billingInfo.storeCreditCode===e.code&&(e.currentBalance-=t.amountRequested)}),e.currentBalance>0?e:!1)}));return r&&r.length>0&&r},applyingCredit:function(){return this._applyingCredit},maxCreditAmountToApply:function(){var e=this.getOrder(),t=e.get("amountRemainingForPayment"),i=this.applyingCredit();return i?Math.min(i.currentBalance,t).toFixed(2):void 0},beginApplyCredit:function(){var e=this.get("selectedCredit");if(this._oldPaymentType=this.get("paymentType"),e){var i=t.findWhere(this.availableStoreCredits(),{code:e});i&&(this._applyingCredit=i,this.set("creditAmountToApply",this.maxCreditAmountToApply()))}},closeApplyCredit:function(){delete this._applyingCredit,this.unset("selectedCredit"),this.set("paymentType",this._oldPaymentType)},finishApplyCredit:function(){var e=this.getOrder(),t=e.apiModel.getCurrentPayment();return t?e.apiVoidPayment(t.id).then(this.addStoreCredit):this.addStoreCredit()},addStoreCredit:function(){var e=this,t=e.getOrder();return t.apiAddStoreCredit({storeCreditCode:this.get("selectedCredit"),amount:this.get("creditAmountToApply")}).then(function(i){return t.set(i.data),e.closeApplyCredit(),i})},onCreditAmountChanged:function(e,t){this.applyDigitalCredit(e.get("code"),t)},loadCustomerDigitalCredits:function(){var e=this,i=this.getOrder(),n=i.get("customer"),a=this.activeStoreCredits(),r=n.get("credits");if(r&&r.length>0){var o=new Date,s=new Date(2076,6,4),d=r.filter(function(e){var t=e.get("currentBalance"),i=e.get("expirationDate"),n=i?new Date(i):s;return!t||0>=t||o>n});t.each(d,function(e){r.remove(e)})}if(e._cachedDigitalCredits=r,a){var l=t.filter(a,function(t){var i=e._cachedDigitalCredits.findWhere({code:t.billingInfo.storeCreditCode});return i?(i.set("isEnabled",!0),i.set("creditAmountApplied",t.amountRequested),i.set("remainingBalance",i.calculateRemainingBalance()),!1):!0});l&&this.convertPaymentsToDigitalCredits(l,n)}},convertPaymentsToDigitalCredits:function(e,i){var n=this;t.each(e,function(e){var t=e;return n.retrieveDigitalCredit(i,t.billingInfo.storeCreditCode,n,t.amountRequested).then(function(e){return n.trigger("orderPayment",n.getOrder().data,n),e})})},availableDigitalCredits:function(){return this._cachedDigitalCredits||this.loadCustomerDigitalCredits(),this._cachedDigitalCredits&&this._cachedDigitalCredits.length>0&&this._cachedDigitalCredits},applyDigitalCredit:function(e,n,r){var o=this,s=o.getOrder(),d=null;this._oldPaymentType=this.get("paymentType");var l=this._cachedDigitalCredits.filter(function(t){return t.get("code")===e});if(!l||0===l.length)return o.deferredError(i.getLabel("digitalCodeAlreadyUsed",e),o);l=l[0];var c=l.get("creditAmountApplied"),u=l.get("isEnabled");n||0===n||(n=o.getMaxCreditToApply(l,o)),l.set("creditAmountApplied",n),l.set("remainingBalance",l.calculateRemainingBalance()),l.set("isEnabled",r),n>0&&(n=o.roundToPlaces(n,2));var p=this.activeStoreCredits();if(p){var h=t.find(p,function(t){return"Voided"!==t.status&&t.billingInfo&&t.billingInfo.storeCreditCode===e});if(h){if(this.areNumbersEqual(h.amountRequested,n)){var g=a.defer();return g.reject(),g.promise}return 0===n?s.apiVoidPayment(h.id).then(function(e){return s.set(e.data),o.trigger("orderPayment",e.data,o),e}):(d=o.getMaxCreditToApply(l,o,h.amountRequested),n>d?(l.set("creditAmountApplied",c),l.set("isEnabled",u),l.set("remainingBalance",l.calculateRemainingBalance()),o.deferredError(i.getLabel("digitalCreditExceedsBalance"),o)):s.apiVoidPayment(h.id).then(function(t){return s.set(t.data),s.apiAddStoreCredit({storeCreditCode:e,amount:n}).then(function(e){return s.set(e.data),o.trigger("orderPayment",e.data,o),e})}))}}return 0===n?this.getOrder():(d=o.getMaxCreditToApply(l,o),n>d?(l.set("creditAmountApplied",c),l.set("remainingBalance",l.calculateRemainingBalance()),l.set("isEnabled",u),o.deferredError(i.getLabel("digitalCreditExceedsBalance"),o)):s.apiAddStoreCredit({storeCreditCode:e,amount:n}).then(function(e){return s.set(e.data),o.trigger("orderPayment",e.data,o),e}))},deferredError:function(e,t){t.trigger("error",{message:e});var i=a.defer();return i.reject(),i.promise},areNumbersEqual:function(e,t){var i=.01;return Math.abs(e-t)<i},retrieveDigitalCredit:function(e,t,n,a){var r=this;return e.apiGetDigitalCredit(t).then(function(e){var o=new s.DigitalCredit(e.data);o.set("isTiedToCustomer",!1);var d=function(){var e=new Date,t=o.get("activationDate")?new Date(o.get("activationDate")):null,n=o.get("expirationDate")?new Date(o.get("expirationDate")):null;return n&&e>n?r.deferredError(i.getLabel("expiredCredit",n.toLocaleDateString()),r):t&&t>e?r.deferredError(i.getLabel("digitalCreditNotYetActive",t.toLocaleDateString()),r):!o.get("currentBalance")||o.get("currentBalance")<=0?r.deferredError(i.getLabel("digitalCreditNoRemainingFunds"),r):null},l=d();if(null!==l)return null;var c=n.getMaxCreditToApply(o,n,a);return a&&c>a&&(c=a),o.set("creditAmountApplied",c),o.set("remainingBalance",o.calculateRemainingBalance()),o.set("isEnabled",!0),n._cachedDigitalCredits.push(o),n.applyDigitalCredit(t,c,!0),n.trigger("sync",o),o})},getDigitalCredit:function(){var e=this,t=e.getOrder(),n=t.get("customer"),r=this.get("digitalCreditCode"),o=this._cachedDigitalCredits.filter(function(e){return e.get("code")===r});if(o&&o.length>0){e.trigger("error",{message:i.getLabel("digitalCodeAlreadyUsed",r)});var s=a.defer();return s.reject(),s.promise}return e.isLoading(!0),e.retrieveDigitalCredit(n,r,e).then(function(){return e.isLoading(!1),e})},getMaxCreditToApply:function(e,t,i){var n=t.nonStoreCreditTotal();i&&(n+=i);var a=n<e.get("currentBalance")?n:e.get("currentBalance");return t.roundToPlaces(a,2)},roundToPlaces:function(e,t){var i=Math.pow(10,t);return Math.round(e*i)/i},digitalCreditPaymentTotal:function(){var e=this.activeStoreCredits();return e?t.reduce(e,function(e,t){return e+t.amountRequested},0):null},addRemainingCreditToCustomerAccount:function(e,t){var n=this,a=n._cachedDigitalCredits.findWhere({code:e});return a?(a.set("addRemainderToCustomer",t),a):n.deferredError(i.getLabel("genericNotFound"),n)},getDigitalCreditsToAddToCustomerAccount:function(){return this._cachedDigitalCredits.where({isEnabled:!0,addRemainderToCustomer:!0,isTiedToCustomer:!1})},isAnonymousShopper:function(){var e=this.getOrder(),t=e.get("customer");return!t||!t.id||t.id<=1},removeCredit:function(e){var t=this.getOrder(),i=t.apiModel.getCurrentPayment();return i&&t.apiVoidPayment(i.id),this.getOrder().apiVoidPayment(e)},syncPaymentMethod:function(e,t){t&&"new"!==t?e.setSavedPaymentMethod(t):(e.get("billingContact").clear(),e.get("card").clear(),e.get("check").clear(),e.unset("paymentType"))},setSavedPaymentMethod:function(e){var t=this,i=t.getOrder().get("customer"),n=i.get("cards").get(e),a=n&&i.get("contacts").get(n.get("contactId"));n&&(t.get("billingContact").set(a.toJSON()),t.get("card").set(n.toJSON()),t.set("paymentType","CreditCard"))},getPaymentTypeFromCurrentPayment:function(){var e=this.get("paymentType"),t=this.getOrder().apiModel.getCurrentPayment(),i=t&&t.billingInfo.paymentType;i&&i!==e&&this.set("paymentType",i)},edit:function(){this.getPaymentTypeFromCurrentPayment(),l.prototype.edit.apply(this,arguments)},initialize:function(){var e=this;t.defer(function(){e.getPaymentTypeFromCurrentPayment(),e.setSavedPaymentMethod(e.get("savedPaymentMethodId"))});var i=this.get("billingContact");this.on("change:paymentType",this.selectPaymentType),this.selectPaymentType(this,this.get("paymentType")),this.on("change:isSameBillingShippingAddress",function(e,t){t&&i.set(this.parent.get("fulfillmentInfo").get("fulfillmentContact").toJSON(),{silent:!0})}),this.on("change:savedPaymentMethodId",this.syncPaymentMethod),this._cachedDigitalCredits=null,t.bindAll(this,"applyPayment","addStoreCredit")},selectPaymentType:function(e,t){e.get("check").selected="Check"===t,e.get("card").selected="CreditCard"===t},calculateStepStatus:function(){var e="complete"===this.parent.get("fulfillmentInfo").stepStatus(),i=this.activePayments(),n=i.length>0,a=i&&!!t.findWhere(i,{paymentType:"CreditCard"}),r=i&&!!t.findWhere(i,{paymentType:"PaypalExpress"}),o=0===this.parent.get("amountRemainingForPayment");return a?this.stepStatus("incomplete"):e?r&&-1===window.location.href.indexOf("PaypalExpress=")?this.stepStatus("incomplete"):n&&(o||"PaypalExpress"===this.get("paymentType")&&-1!==window.location.href.indexOf("PaypalExpress=complete"))?this.stepStatus("complete"):this.stepStatus("incomplete"):this.stepStatus("new")},getPaypalUrls:function(){var e=window.location.href+(-1!==window.location.href.indexOf("?")?"&":"?");return-1!=e.indexOf("PaypalExpress=")&&(e=e.substring(0,e.indexOf("PaypalExpress="))),{paypalReturnUrl:e+"PaypalExpress=complete",paypalCancelUrl:e+"PaypalExpress=canceled"}},submit:function(){var e=this.getOrder();if(e.syncBillingAndCustomerEmail(),this.nonStoreCreditTotal()>0&&this.validate())return!1;var t=e.apiModel.getCurrentPayment();return t?e.apiVoidPayment(t.id).then(this.applyPayment):this.applyPayment()},applyPayment:function(){var e=this,t=this.getOrder();return"PaypalExpress"===this.get("paymentType")?this.set(this.getPaypalUrls()):(this.unset("paypalReturnUrl"),this.unset("paypalCancelUrl")),this.syncApiModel(),this.nonStoreCreditTotal()>0?t.apiAddPayment().then(function(){var i=t.apiModel.getCurrentPayment();i&&"PaypalExpress"!==i.paymentType&&e.markComplete()}):(this.markComplete(),void 0)},markComplete:function(){this.stepStatus("complete"),this.isLoading(!1),this.getOrder().isReady(!0)},toJSON:function(){var e=l.prototype.toJSON.apply(this,arguments);return 0===this.nonStoreCreditTotal()&&e.billingContact&&delete e.billingContact.address,e.billingContact&&!e.billingContact.email&&(e.billingContact.email=this.getOrder().get("customer.emailAddress")),e}}),h=n.MozuModel.extend(),g={emailAddress:{fn:function(e){return!this.attributes.createAccount||e&&e.match(n.Validation.patterns.email)?void 0:i.getLabel("emailMissing")}},password:{fn:function(e){return this.attributes.createAccount&&!e?i.getLabel("passwordMissing"):void 0}},confirmPassword:{fn:function(e){return this.attributes.createAccount&&e!==this.get("password")?i.getLabel("passwordsDoNotMatch"):void 0}}};i.getThemeSetting("requireCheckoutAgreeToTerms")&&(g.agreeToTerms={acceptance:!0,msg:i.getLabel("didNotAgreeToTerms")});var m=n.MozuModel.extend({mozuType:"order",handlesMessages:!0,relations:{fulfillmentInfo:u,billingInfo:p,shopperNotes:h,customer:r.Customer},validation:g,dataTypes:{createAccount:n.MozuModel.DataTypes.Boolean,acceptsMarketing:n.MozuModel.DataTypes.Boolean,amountRemainingForPayment:n.MozuModel.DataTypes.Float},initialize:function(e){var n=this,a=require.mozuData("user");t.defer(function(){var e=n.apiModel.getCurrentPayment(),r=n.get("fulfillmentInfo"),o=r.get("fulfillmentContact"),s=n.get("billingInfo"),d=[r,o,s],l=e&&"PaypalExpress"===e.paymentType&&-1!==window.location.href.indexOf("PaypalExpress=canceled"),c=function(){return"completecompletecomplete"===t.reduce(d,function(e,t){return e+t.stepStatus()},"")},u=c()&&!l;n.isReady(u),t.each(d,function(e){n.listenTo(e,"stepstatuschange",function(){t.defer(function(){n.isReady(c())})})}),n.get("requiresFulfillmentInfo")||(n.validation=t.pick(n.constructor.prototype.validation,t.filter(t.keys(n.constructor.prototype.validation),function(e){return-1===e.indexOf("fulfillment")}))),n.get("billingInfo.billingContact").on("change:email",function(e,t){n.set("email",t)});var p=s.get("billingContact.email");!p&&a.email&&s.set("billingContact.email",a.email),l&&n.apiVoidPayment(e.id).then(function(e){return n.set(e.data),n.trigger("error",{message:i.getLabel("paypalExpressCancelled")}),e})}),a.isAuthenticated&&this.set("customer",{id:a.accountId}),null===e.acceptsMarketing&&n.set("acceptsMarketing",!0),t.bindAll(this,"update","onCheckoutSuccess","onCheckoutError","addNewCustomer","saveCustomerCard","finalPaymentReconcile","apiCheckout","addDigitalCreditToCustomerAccount","addCustomerContact","addBillingContact","addShippingContact","addShippingAndBillingContact")},addCoupon:function(){var e=this,n=this.get("couponCode"),r=e.get("orderDiscounts");if(r&&t.findWhere(r,{couponCode:n})){var o=a.defer();return o.reject(),o.promise.otherwise(function(){e.trigger("error",{message:i.getLabel("promoCodeAlreadyUsed",n)})}),o.promise}return this.isLoading(!0),this.apiAddCoupon(this.get("couponCode")).then(function(){e.set("couponCode","");var a=t.flatten(t.pluck(e.get("items"),"productDiscounts")),r=t.flatten(t.pluck(t.flatten(t.pluck(e.get("items"),"shippingDiscounts")),"discount")),o=t.flatten(t.pluck(e.get("shippingDiscounts"),"discount")),s=e.get("orderDiscounts").concat(a).concat(r).concat(o),d=n.toLowerCase();s&&t.find(s,function(e){return e.couponCode.toLowerCase()===d})||e.trigger("error",{message:i.getLabel("promoCodeError",n)}),e.isLoading(!1)})},onCheckoutSuccess:function(){this.isLoading(!0),this.trigger("complete")},onCheckoutError:function(n){var a=this,r=!1;if(a.isLoading(!1),!n||!n.items||0===n.items.length){if(-1!=n.message.indexOf("10486")){var o=d.locals.siteContext,s=t.findWhere(o.checkoutSettings.externalPaymentWorkflowSettings,{name:"PayPalExpress2"}),l=t.findWhere(s.credentials,{apiName:"environment"}),c="";return c="sandbox"===l.value.toLowerCase()?"https://www.sandbox.paypal.com":"https://www.paypal.com",window.location.href=c+"/cgi-bin/webscr?cmd=_express-checkout&token="+a.get("payments")[a.get("payments").length-1].externalTransactionId,void 0}n={items:[{message:n.message||i.getLabel("unknownError")}]}}throw e.each(n.items,function(e,t){"ADD_CUSTOMER_FAILED"===t.name&&t.message.toLowerCase().indexOf("invalid parameter: password")&&(r=!0,a.trigger("passwordinvalid",t.message.substring(t.message.indexOf("Password")))),"ADD_CUSTOMER_FAILED"===t.errorCode&&t.message.toLowerCase().indexOf("invalid parameter: emailaddress")&&(r=!0,a.trigger("userexists",a.get("emailAddress")))}),this.trigger("error",n),r||a.messages.reset(n.items),a.isSubmitting=!1,n},addNewCustomer:function(){var e=this,t=this.get("billingInfo"),i=t.get("billingContact"),n=this.get("emailAddress"),r=function(t){if(t&&("customer"===t.type||"login"===t.type)){var i;"customer"===t.type&&(i=t.data),"login"===t.type&&(i=t.data.customerAccount),i&&i.id&&(e.set("customer",i),a.off("sync",r),a.off("spawn",r))}};return a.on("sync",r),a.on("spawn",r),this.apiAddNewCustomer({account:{emailAddress:n,userName:n,firstName:i.get("firstName")||this.get("fulfillmentInfo.fulfillmentContact.firstName"),lastName:i.get("lastNameOrSurname")||this.get("fulfillmentInfo.fulfillmentContact.lastNameOrSurname"),acceptsMarketing:e.get("acceptsMarketing")},password:this.get("password")}).then(function(t){return e.customerCreated=!0,t},function(t){throw e.customerCreated=!1,e.isSubmitting=!1,t})},addBillingContact:function(){return this.addCustomerContact("billingInfo","billingContact",[{name:"Billing"}])},addShippingContact:function(){return this.addCustomerContact("fulfillmentInfo","fulfillmentContact",[{name:"Shipping"}])},addShippingAndBillingContact:function(){return this.addCustomerContact("fulfillmentInfo","fulfillmentContact",[{name:"Shipping"},{name:"Billing"}])},addCustomerContact:function(e,i,n){var r=this.get("customer"),o=this.get(e),s=o.get(i).toJSON(),d=[function(){return(-1===s.id||1===s.id||"new"===s.id)&&delete s.id,r.apiModel.addContact(s).then(function(e){return s.id=e.data.id,e})}];this.isSavingNewCustomer()?t.each(n,function(e){e.isPrimary=!0}):d.unshift(function(){return r.apiModel.getContacts().then(function(e){t.each(n,function(i){var n=t.find(e.data.items,function(e){return t.find(e.types||[],function(e){return e.name===i.name&&e.isPrimary})});i.isPrimary=!n})})}),s.email||(s.email=this.get("emailAddress")||r.get("emailAddress")||require.mozuData("user").email);var l=s.contactId;if(l&&(s.id=l),s.id&&-1!==s.id&&1!==s.id&&"new"!==s.id){var c=a.defer();return c.resolve(),c.promise}return s.types=n,a.steps(d)},saveCustomerCard:function(){var e=this,t=this.get("customer"),i=this.get("billingInfo"),n=i.get("isSameBillingShippingAddress"),a=this.isSavingNewCustomer(),r=i.get("billingContact").toJSON(),o=i.get("card"),s=function(){e.cardsSaved=e.cardsSaved||t.get("cards").reduce(function(e,t){return e[t.id]=!0,e},{});var i=e.cardsSaved[o.get("id")||o.get("paymentServiceCardId")]?"updateCard":"addCard";return o.set("contactId",r.id),t.apiModel[i](o.toJSON()).then(function(t){return e.cardsSaved[t.data.id]=!0,t})},d=function(){return(-1===r.id||1===r.id)&&delete r.id,t.apiModel.addContact(r).then(function(e){return r.id=e.data.id,e})},l=r.contactId;return l&&(r.id=l),r.id&&-1!==r.id&&1!==r.id&&"new"!==r.id?s():(r.types=n?[{name:"Shipping",isPrimary:a},{name:"Billing",isPrimary:a}]:[{name:"Billing",isPrimary:a}],d().then(s))},setFulfillmentContactEmail:function(){var e=this.get("fulfillmentInfo.fulfillmentContact.email"),t=this.get("email");e||this.set("fulfillmentInfo.fulfillmentContact.email",t)},syncBillingAndCustomerEmail:function(){var e=this.get("billingInfo.billingContact.email"),t=this.get("emailAddress")||require.mozuData("user").email;t||this.set("emailAddress",e),e||this.set("billingInfo.billingContact.email",t)},addDigitalCreditToCustomerAccount:function(){var e=this.get("billingInfo"),i=this.get("customer"),n=e.getDigitalCreditsToAddToCustomerAccount();return n?t.each(n,function(e){return i.apiAddStoreCredit(e.get("code"))}):void 0},isSavingNewCustomer:function(){return this.get("createAccount")&&!this.customerCreated},finalPaymentReconcile:function(){var e,n,r=this,o=this.get("total"),s=this.apiModel.getActivePayments(),d=this.apiModel.getCurrentPayment(),l=Math.round(100*(t.reduce(s,function(e,t){return e+t.amountRequested},0)-o))/100;return 0===l?(n=a.defer(),n.resolve(!0),n.promise):(e=r.get("billingInfo"),!d||s.length>1||"PaypalExpress"===d.paymentType||0>l?a.all.apply(a,s.map(function(e){return r.apiVoidPayment(e.id)})).then(function(){return r.get("customer.credits").each(function(e){e.set({isEnabled:!1,creditAmountApplied:0,remainingBalance:e.get("currentBalance")})}),e.loadCustomerDigitalCredits()}).then(function(){throw e.clear(),e.stepStatus("incomplete"),new Error(i.getLabel("recalculatePayments"))}):r.apiVoidPayment(d.id).then(function(){return d.amountRequested=o,e.set(d),e.applyPayment()}))},isMozuCheckout:function(){var e=this.apiModel.getActivePayments();return!!(e&&(t.findWhere(e,{paymentType:"CreditCard"})||t.findWhere(e,{paymentType:"Check"})||t.findWhere(e,{paymentType:"PaypalExpress"})||t.findWhere(e,{paymentType:"VisaCheckout"})||t.findWhere(e,{paymentType:"StoreCredit"})||t.findWhere(e,{paymentType:"GiftCard"})))},submit:function(){var e=this,t=this.get("billingInfo"),i=t.get("billingContact"),n=t.get("isSameBillingShippingAddress"),r=!1,o=this.isSavingNewCustomer(),s=require.mozuData("user").isAuthenticated,d=t.nonStoreCreditTotal(),l=this.get("requiresFulfillmentInfo"),c=d>0,u=this.apiModel.getCurrentPayment();if(this.isMozuCheckout()||i.set("address",null),process=[function(){return e.update({ipAddress:e.get("ipAddress"),shopperNotes:e.get("shopperNotes").toJSON()})}],!this.isSubmitting){if(this.isSubmitting=!0,c&&!i.isValid()&&i.set(this.apiModel.getCurrentPayment().billingInfo.billingContact),this.syncBillingAndCustomerEmail(),this.setFulfillmentContactEmail(),d>0&&this.validate()&&("PayPalExpress2"!==u.paymentWorkflow||this.validate().agreeToTerms))return this.isSubmitting=!1,!1;this.isLoading(!0),o&&process.push(this.addNewCustomer);var p=t.get("card");"CreditCard"===t.get("paymentType")&&p.get("isCardInfoSaved")&&(this.get("createAccount")||s)&&(r=!0,process.push(this.saveCustomerCard)),(this.get("createAccount")||s)&&t.getDigitalCreditsToAddToCustomerAccount().length>0&&process.push(this.addDigitalCreditToCustomerAccount),(s||o)&&(n||r?n&&!r?process.push(this.addShippingAndBillingContact):!n&&r&&l&&process.push(this.addShippingContact):(l&&process.push(this.addShippingContact),c&&process.push(this.addBillingContact))),process.push(this.finalPaymentReconcile,this.apiCheckout),a.steps(process).then(this.onCheckoutSuccess,this.onCheckoutError)}},update:function(){var e=this.toJSON();return this.apiModel.update(e)},refresh:function(){var e=this;return this.trigger("beforerefresh"),this.apiGet().then(function(){e.trigger("refresh")})},runForAllSteps:function(e){var i=this;t.each(["fulfillmentInfo.fulfillmentContact","fulfillmentInfo","billingInfo"],function(t){e.call(i.get(t))})},isReady:function(e){this.set("isReady",e)},toJSON:function(e){var t=n.MozuModel.prototype.toJSON.apply(this,arguments);return e&&e.helpers||(delete t.password,delete t.confirmPassword),t}});return{CheckoutPage:m}}),define("modules/preserve-element-through-render",["underscore"],function(e){return function(t,i,n){var a={};t._preserved=t._preserved||{},e.each(i,function(e){a[e]=t.$(e)}),n.call(t),e.each(a,function(e,i){var n=t._preserved[i];e.length>0&&(!n||0===n.length)&&(n=t._preserved[i]=e),n&&n.length>0&&t.$(i).replaceWith(n)})}}),require(["modules/jquery-mozu","underscore","hyprlive","modules/backbone-mozu","modules/models-checkout","modules/views-messages","modules/cart-monitor","hyprlivecontext","modules/preserve-element-through-render"],function(t,i,n,a,r,o,s,d,l){var c=a.MozuView.extend({edit:function(){this.model.edit()},next:function(){var e=this;i.defer(function(){e.model.next()})},choose:function(){var e=this;e.model.choose.apply(e.model,arguments)},constructor:function(){var e=this;a.MozuView.apply(this,arguments),e.resize(),setTimeout(function(){e.$(".mz-panel-wrap").css({"overflow-y":"hidden"})},250),e.listenTo(e.model,"stepstatuschange",e.render,e),e.$el.on("keypress","input",function(t){return 13===t.which?(e.handleEnterKey(t),!1):void 0})},initStepView:function(){this.model.initStep()},handleEnterKey:function(){this.model.next()},render:function(){this.$el.removeClass("is-new is-incomplete is-complete is-invalid").addClass("is-"+this.model.stepStatus()),a.MozuView.prototype.render.apply(this,arguments),this.resize()},resize:i.debounce(function(){this.$(".mz-panel-wrap").animate({height:this.$(".mz-inner-panel").outerHeight()})},200)}),u=a.MozuView.extend({templateName:"modules/checkout/checkout-order-summary",initialize:function(){this.listenTo(this.model.get("billingInfo"),"orderPayment",this.onOrderCreditChanged,this)},editCart:function(){window.location="/cart"},onOrderCreditChanged:function(){this.render()},handleLoadingChange:function(){}}),p=c.extend({templateName:"modules/checkout/step-shipping-address",autoUpdate:["firstName","lastNameOrSurname","address.address1","address.address2","address.address3","address.cityOrTown","address.countryCode","address.stateOrProvince","address.postalOrZipCode","address.addressType","phoneNumbers.home","contactId","email"],renderOnChange:["address.countryCode","contactId"]}),h=c.extend({templateName:"modules/checkout/step-shipping-method",renderOnChange:["availableShippingMethods"],additionalEvents:{"change [data-mz-shipping-method]":"updateShippingMethod"},updateShippingMethod:function(){this.model.updateShippingMethod(this.$("[data-mz-shipping-method]:checked").val())}}),g=c.extend({templateName:"modules/checkout/step-payment-info",autoUpdate:["savedPaymentMethodId","paymentType","card.paymentOrCardType","card.cardNumberPartOrMask","card.nameOnCard","card.expireMonth","card.expireYear","card.cvv","card.isCardInfoSaved","check.nameOnCheck","check.routingNumber","check.checkNumber","isSameBillingShippingAddress","billingContact.firstName","billingContact.lastNameOrSurname","billingContact.address.address1","billingContact.address.address2","billingContact.address.address3","billingContact.address.cityOrTown","billingContact.address.countryCode","billingContact.address.stateOrProvince","billingContact.address.postalOrZipCode","billingContact.phoneNumbers.home","billingContact.email","creditAmountToApply","digitalCreditCode"],renderOnChange:["savedPaymentMethodId","billingContact.address.countryCode","paymentType","isSameBillingShippingAddress"],additionalEvents:{"change [data-mz-digital-credit-enable]":"enableDigitalCredit","change [data-mz-digital-credit-amount]":"applyDigitalCredit","change [data-mz-digital-add-remainder-to-customer]":"addRemainderToCustomer",'change [data-mz-value="card.paymentOrCardType"]':"foobar",'change [data-mz-value="card.cardNumberPartOrMask"]':"foobar",'change [data-mz-value="card.nameOnCard"]':"foobar",'change [data-mz-value="card.expireMonth"]':"foobar",'change [data-mz-value="card.expireYear"]':"foobar"},foobar:function(){var e=this.model.get("card"),i=t("#mz-payment-credit-card-number");e&&e.get("paymentServiceCardId")&&(e.unset("paymentServiceCardId"),i&&-1!==i.val().indexOf("*")&&i.val(""))},initialize:function(){this.listenTo(this.model,"change:digitalCreditCode",this.onEnterDigitalCreditCode,this),this.listenTo(this.model,"orderPayment",function(){this.render()},this),this.codeEntered=!!this.model.get("digitalCreditCode")},render:function(){l(this,[".v-button",".p-button"],function(){c.prototype.render.apply(this,arguments)
});this.model.stepStatus()},updateAcceptsMarketing:function(){this.model.getOrder().set("acceptsMarketing",t(e.currentTarget).prop("checked"))},beginApplyCredit:function(){this.model.beginApplyCredit(),this.render()},cancelApplyCredit:function(){this.model.closeApplyCredit(),this.render()},finishApplyCredit:function(){var e=this;this.model.finishApplyCredit().then(function(){e.render()})},removeCredit:function(e){var i=this,n=t(e.currentTarget).data("mzCreditId");this.model.removeCredit(n).then(function(){i.render()})},getDigitalCredit:function(){var e=this;this.$el.addClass("is-loading"),this.model.getDigitalCredit().ensure(function(){e.$el.removeClass("is-loading")})},stripNonNumericAndParseFloat:function(e){if(!e)return 0;var t=parseFloat(e.replace(/[^\d\.]/g,""));return isNaN(t)?0:t},applyDigitalCredit:function(e){var i=t(e.currentTarget).prop("value"),n=t(e.currentTarget).attr("data-mz-credit-code-target");if(!n)return console.log("checkout.applyDigitalCredit could not find target."),void 0;var a=this.stripNonNumericAndParseFloat(i);this.model.applyDigitalCredit(n,a,!0),this.render()},onEnterDigitalCreditCode:function(e,t){t&&!this.codeEntered&&(this.codeEntered=!0,this.$el.find("button").prop("disabled",!1)),!t&&this.codeEntered&&(this.codeEntered=!1,this.$el.find("button").prop("disabled",!0))},enableDigitalCredit:function(e){var i=t(e.currentTarget).attr("data-mz-credit-code-source"),n=t(e.currentTarget).prop("checked")===!0,a=this.$el.find("input[data-mz-credit-code-target='"+i+"']"),r=this;n?(a.prop("disabled",!1),r.model.applyDigitalCredit(i,null,!0)):(a.prop("disabled",!0),r.model.applyDigitalCredit(i,0,!1),r.render())},addRemainderToCustomer:function(e){var i=t(e.currentTarget).attr("data-mz-credit-code-to-tie-to-customer"),n=t(e.currentTarget).prop("checked")===!0;this.model.addRemainingCreditToCustomerAccount(i,n)},handleEnterKey:function(e){var i=t(e.currentTarget).attr("data-mz-value");if(i)switch(i){case"creditAmountApplied":return this.applyDigitalCredit(e);case"digitalCreditCode":return this.getDigitalCredit(e)}}}),m=a.MozuView.extend({templateName:"modules/checkout/coupon-code-field",handleLoadingChange:function(){},initialize:function(){var e=this;this.listenTo(this.model,"change:couponCode",this.onEnterCouponCode,this),this.codeEntered=!!this.model.get("couponCode"),this.$el.on("keypress","input",function(t){return 13===t.which?(e.codeEntered&&e.handleEnterKey(),!1):void 0})},onEnterCouponCode:function(e,t){t&&!this.codeEntered&&(this.codeEntered=!0,this.$el.find("button").prop("disabled",!1)),!t&&this.codeEntered&&(this.codeEntered=!1,this.$el.find("button").prop("disabled",!0))},autoUpdate:["couponCode"],addCoupon:function(){var e=this;this.$el.addClass("is-loading"),this.model.addCoupon().ensure(function(){e.$el.removeClass("is-loading"),e.model.unset("couponCode"),e.render()})},handleEnterKey:function(){this.addCoupon()}}),f=a.MozuView.extend({templateName:"modules/checkout/comments-field",autoUpdate:["shopperNotes.comments"]}),C=a.MozuView.extend({templateName:"modules/checkout/step-review",autoUpdate:["createAccount","agreeToTerms","emailAddress","password","confirmPassword"],renderOnChange:["createAccount","isReady"],initialize:function(){var e=this;this.$el.on("keypress","input",function(t){return 13===t.which?(e.handleEnterKey(),!1):void 0}),this.model.on("passwordinvalid",function(t){e.$('[data-mz-validationmessage-for="password"]').text(t)}),this.model.on("userexists",function(t){e.$('[data-mz-validationmessage-for="emailAddress"]').html(n.getLabel("customerAlreadyExists",t,encodeURIComponent(window.location.pathname)))})},submit:function(){var e=this;i.defer(function(){e.model.submit()})},handleEnterKey:function(){this.submit()}}),y=function(e){function i(){e.el.css("opacity",1),r&&r.remove()}var a=parseInt(n.getThemeSetting("gutterWidth"),10);isNaN(a)&&(a=15);var r;return e.model.on("beforerefresh",function(){i(),e.el.css("opacity",.5);var n=e.el.position();r=t("<div></div>",{"class":"mz-checkout-mask"}).css({width:e.el.outerWidth()+2*a,height:e.el.outerHeight()+2*a,top:n.top-a,left:n.left-a}).insertAfter(e.el)}),e.model.on("refresh",i),e.model.on("error",i),e};t(document).ready(function(){var e=t("#checkout-form"),a=require.mozuData("checkout"),d=window.order=new r.CheckoutPage(a),l={parentView:new y({el:e,model:d}),steps:{shippingAddress:new p({el:t("#step-shipping-address"),model:d.get("fulfillmentInfo").get("fulfillmentContact")}),shippingInfo:new h({el:t("#step-shipping-method"),model:d.get("fulfillmentInfo")}),paymentInfo:new g({el:t("#step-payment-info"),model:d.get("billingInfo")})},orderSummary:new u({el:t("#order-summary"),model:d}),couponCode:new m({el:t("#coupon-code-field"),model:d}),comments:n.getThemeSetting("showCheckoutCommentsField")&&new f({el:t("#comments-field"),model:d}),reviewPanel:new C({el:t("#step-review"),model:d}),messageView:o({el:e.find("[data-mz-message-bar]"),model:d.messages})};window.checkoutViews=l,d.on("complete",function(){s.setCount(0),window.location="/checkout/"+d.get("id")+"/confirmation"});var c=t("#step-review");d.on("change:isReady",function(e,t){t&&setTimeout(function(){window.scrollTo(0,c.offset().top)},750)}),i.invoke(l.steps,"initStepView"),e.noFlickerFadeIn()})}),define("pages/checkout",function(){});